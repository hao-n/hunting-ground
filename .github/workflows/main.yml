name: CI

on: [push, pull_request]

jobs:
  hotspot-supported:
    name: Any (supported)
    strategy:
      fail-fast: false
      matrix:
        container: 
          - bugswarm/githubactionsjobrunners:ubuntu-18.04-aug2021
          - bugswarm/githubactionsjobrunners:ubuntu-20.04-aug2021
        java: [ 8, 11, 17, 18 ]
    runs-on: self-hosted
    container: ${{ matrix.container }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }}
          distribution: temurin
          architecture: x64
          cache: maven
      - name: Build project
        run: ./mvnw verify -Pintegration -Pjava${{ matrix.java }}
  hotspot-legacy:
    name: HotSpot (legacy)
    strategy:
      fail-fast: false
      matrix:
        container: 
          - bugswarm/githubactionsjobrunners:ubuntu-18.04
        java: [ 6, 7 ]
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      - uses: actions/cache@v2
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-legacy-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-legacy-maven-
      - uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java }}
          distribution: zulu
          architecture: x64
      - name: Build project
        run: ./mvnw -s .mvn/nossl.settings.xml -U verify -Pintegration -Pjava${{ matrix.java }}
  # coverage:
  #   name: Coverage
  #   runs-on: ubuntu-18.04
  #   needs: [ hotspot-supported ]
  #   if: github.event_name == 'push'
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-java@v2
  #       with:
  #         java-version: 8
  #         distribution: temurin
  #         architecture: x64
  #         cache: maven
  #     - name: Build project
  #       run: ./mvnw jacoco:prepare-agent verify jacoco:report coveralls:report -DrepoToken=${{ secrets.coveralls }} -Pintegration -Pextras -Pchecks
